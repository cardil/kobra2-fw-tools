name: Build Test

on:
  push:
    branches:
      - main
      - 'release-**'
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - 'release-**'
  workflow_dispatch:

env:
  FORCE_COLOR: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up QEMU for ARM emulation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          squashfs-tools \
          cpio \
          unzip \
          zip \
          gawk \
          python3 \
          git \
          make \
          npm \
          g++ \
          rsync \
          curl \
          openssl \
          dialog
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Python dependencies
      run: pip3 install pycryptodome
    
    - name: Download firmware
      run: ./fwdl.sh K2Pro 3.1.2
      env:
        # Using Mitm archiver to bypass upstream downlods
        HTTPS_PROXY: http://${{ secrets.PROXY_PASS }}@${{ secrets.PROXY_HOST }}
        CURL_CA_BUNDLE: .github/workflows/mitmproxy-ca-cert.pem
    
    - name: Build firmware
      run: ./build.sh AC104_K2Pro_1.1.0_3.1.2_update.bin
      env:
        USE_DOCKER: 1
    
    - name: Verify build output
      run: |
        test -f FW/modded/K2Pro-3.1.2.swu
        echo "âœ“ Firmware built successfully"